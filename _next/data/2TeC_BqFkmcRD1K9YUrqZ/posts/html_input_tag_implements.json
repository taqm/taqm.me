{"pageProps":{"post":"{\"slug\":\"html_input_tag_implements\",\"title\":\"HTMLのinputタグ[type=file]のブラウザごとの挙動について調べてみた\",\"publishedAt\":\"2018-12-24T23:44:11.000Z\",\"description\":\"input[type=file]でファイル選択後にファイルを消した場合の動作などを各ブラウザの実装を確かめてみました。\",\"tags\":[\"HTML\"]}","content":"<h2 class=\"heading lv-2\">はじめに</h2>\n<p class=\"paragraph\">みなさんHTMLタグの一つである<code class=\"code\">input</code>タグはご存知だと思います。\nその中でも<a href=\"http://www.htmq.com/html/input_file.shtml\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\">type=\"file\"</a>についてぼくはこんな疑問を持ちました。</p>\n<p class=\"paragraph\"><strong>選択したファイルはどこのファイル？コピーとかされているの？</strong></p>\n<p class=\"paragraph\">これみなさん知っていますか？\nちょこっと調べたんですがなかなか情報がなかったので\nいろいろ自分で調査してみました。</p>\n<p class=\"paragraph\">（本音は調査が面白そうだったのでそんなに本気で調べてないだけです</p>\n<h2 class=\"heading lv-2\">仮説を立てる</h2>\n<p class=\"paragraph\">まずは仮説をいくつか立ててそれぞれを検証していきます</p>\n<p class=\"paragraph\">A. ブラウザはファイル参照だけ持っている\nB. ファイル選択時にTemp領域へコピーしている\nC. メモリ上に抱えている</p>\n<p class=\"paragraph\">たぶんこれらのどれかじゃないかなと思っており、\n個人的にはBが濃厚だと勝手に考えています。</p>\n<h2 class=\"heading lv-2\">調査開始</h2>\n<p class=\"paragraph\">ファイルアップロード機能が必要なので\n簡単にファイルをアップロードするだけのアプリを自前で作りました。\n<a href=\"https://github.com/taqm/go-simple-fileup\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\">https://github.com/taqm/go-simple-fileup</a></p>\n<p class=\"paragraph\">これは・・・雑の極みっ・・・！\n気にせずこれで検証を行っていきましょう</p>\n<h3 class=\"heading lv-3\">A. ブラウザはファイル参照だけ持っている 説</h3>\n<p class=\"paragraph\">まずはこちら検証していきましょう</p>\n<h4 class=\"heading lv-4\">説の内容</h4>\n<ul class=\"list unordered\">\n<li>ブラウザはアップロード対象ファイルへの参照だけを保持</li>\n<li>ファイルをアップロードする際は実際のファイルがそのまま送信される</li>\n</ul>\n<p class=\"paragraph\">こんなところでしょうか</p>\n<h4 class=\"heading lv-4\">検証内容</h4>\n<p class=\"paragraph\">もしブラウザがファイルへの参照を持っているだけならば、\nファイル選択後にファイルを更新したときに更新後のファイルが送信されるはず！</p>\n<p class=\"paragraph\">作った検証用アプリを使って検証してみます</p>\n<p class=\"paragraph\">まずは適当なテキストファイルを用意します。</p>\n<div class=\"has-filename\"><div class=\"filename\">sample.txt</div><pre class=\"language-unknown pre\"><code class=\"language-unknown code\">hoge</code></pre></div>\n<p class=\"paragraph\">そしてこのファイルを選択後に更新してから送信してみます。</p>\n<div class=\"has-filename\"><div class=\"filename\">sample.txt（更新後</div><pre class=\"language-unknown pre\"><code class=\"language-unknown code\">fuga</code></pre></div>\n<h4 class=\"heading lv-4\">結果</h4>\n<p class=\"paragraph\">送信されたファイルの中身は以下でした</p>\n<div class=\"has-filename\"><div class=\"filename\">sample.txt</div><pre class=\"language-unknown pre\"><code class=\"language-unknown code\">fuga</code></pre></div>\n<p class=\"paragraph\">更新されてる...\nあれー？\n一番ないと思っていた仮説だったのにいきなりヒット？</p>\n<p class=\"paragraph\">では更新だけでなくファイル選択後に、対象ファイルを削除してみましょう</p>\n<p class=\"paragraph\">なんと！リクエストに失敗してしまいました。</p>\n<p class=\"paragraph\">やはりただファイル参照を持っているだけで\n実際のファイルへの更新を行うと、選択しているファイルにも影響が起きるようです。</p>\n<h3 class=\"heading lv-3\">ブラウザごとの挙動</h3>\n<p class=\"paragraph\">こういう問題はブラウザごとに違うのでは？という疑問が出てきます。\n先に述べた実証はChromeで行っていたため\n他のブラウザではどうなっているのか見てみましょう</p>\n<h4 class=\"heading lv-4\">Safari</h4>\n<p class=\"paragraph\"><strong>選択後に、更新した場合</strong>\nやはり送信されたファイルは更新後の内容になっていました。\nChromeと同じ動きです。</p>\n<p class=\"paragraph\"><strong>選択後に、削除した場合</strong>\n削除後に送信した結果、\n同名の空ファイルが送信されてしまいました。</p>\n<h4 class=\"heading lv-4\">Firefox</h4>\n<p class=\"paragraph\"><strong>選択後に、更新した場合</strong>\n送信されたファイルは更新後の内容になっていました。\nChromeやSafariと同じ動きです。</p>\n<p class=\"paragraph\"><strong>選択後に、削除した場合</strong>\nファイルの送信が行われませんでした。\nそもそもファイルが選択されていないような動きになっています。</p>\n<h4 class=\"heading lv-4\">Microsoft Edge</h4>\n<p class=\"paragraph\"><strong>選択後に、更新した場合</strong>\nなんと同名の空ファイルが送信されてしまいました。</p>\n<p class=\"paragraph\"><strong>選択後に、削除した場合</strong>\n削除の場合も、更新と同様に空ファイルが送信されています。</p>\n<h4 class=\"heading lv-4\">Internet Exproler 11</h4>\n<p class=\"paragraph\"><strong>選択後に、更新した場合</strong>\nChromeやSafari同様に更新後の内容が送信されました。</p>\n<p class=\"paragraph\"><strong>選択後に、削除した場合</strong>\nなんと削除前のファイルが正常に送信されるではありませんか。\nそして</p>\n<p class=\"paragraph\">選択　→　更新　→　削除　→　送信</p>\n<p class=\"paragraph\">と操作を行った場合には更新されたファイルが送信されていました。</p>\n<h4 class=\"heading lv-4\">ブラウザ別の挙動まとめ</h4>\n<p class=\"paragraph\">ブラウザごとに送信されたファイルをまとめてみます。</p>\n<table class=\"table\">\n<thead class=\"thead\">\n<tr class=\"tr\">\n<th class=\"th\">　</th>\n<th class=\"th\">選択後に更新</th>\n<th class=\"th\">選択後に削除</th>\n</tr>\n</thead>\n<tbody class=\"tbody\">\n<tr class=\"tr\">\n<td class=\"td\">Chrome</td>\n<td class=\"td\">更新後のファイル</td>\n<td class=\"td\">エラー発生</td>\n</tr>\n<tr class=\"tr\">\n<td class=\"td\">Safari</td>\n<td class=\"td\">更新後のファイル</td>\n<td class=\"td\">空ファイル</td>\n</tr>\n<tr class=\"tr\">\n<td class=\"td\">Firefox</td>\n<td class=\"td\">更新後のファイル</td>\n<td class=\"td\">送信せず</td>\n</tr>\n<tr class=\"tr\">\n<td class=\"td\">Edge</td>\n<td class=\"td\">空ファイル</td>\n<td class=\"td\">空ファイル</td>\n</tr>\n<tr class=\"tr\">\n<td class=\"td\">IE11</td>\n<td class=\"td\">更新後のファイル</td>\n<td class=\"td\">削除前のファイル</td>\n</tr>\n</tbody>\n</table>\n<p class=\"paragraph\">バラバラだ</p>\n<h2 class=\"heading lv-2\">結論</h2>\n<p class=\"paragraph\"><code class=\"code\">input(type=file)</code>でファイルを選択した場合は\nファイルのへの参照を持っているだけであり、\n選択後にファイルを更新・削除を行うと選択したファイルへ反映される。</p>\n<p class=\"paragraph\">ただし、反映のされ方はブラウザごとに挙動が異なる。</p>\n<h2 class=\"heading lv-2\">あとがき</h2>\n<p class=\"paragraph\">正直ファイルの参照を持っているだけだとは思っていませんでした。\n改めて考えてみると、コピーなんてしていたら容量も時間もかかるのでありえないんですが・・・ｗ</p>\n<p class=\"paragraph\">でもまあ調査した結果としてはとても面白い内容となったので満足感ありです！\nまだIEの細かな仕様やスマホだとどうなのかなど色々気になることもあるので\n時間ができたら記事を更新していきます！</p>\n<h5 class=\"heading lv-5\">追記　</h5>\n<p class=\"paragraph\">2018/12/25時点での検証結果になるため、ブラウザの更新により挙動が変更される可能性があります。</p>\n<hr>\n<p class=\"paragraph\">おしまい</p>"},"__N_SSG":true}