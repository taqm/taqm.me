<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-X38HKLJWTQ"></script><script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X38HKLJWTQ', { page_path: window.location.pathname, }); </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="robots" content="nofollow noindex"/><title>ExpressでServer Sent Event (SSE) を簡単に扱ってみる | taqm&#x27;s blog</title><meta name="keywords" content="JavaScript,Node.js"/><meta name="description" content="ServerSentEventをNode.jsのライブラリであるexpressから利用しやすくするライブラリを作ったので解説します。"/><meta property="og:url" content="https://taqm.me/posts/sse_express"/><meta property="og:type" content="article"/><meta property="og:title" content="ExpressでServer Sent Event (SSE) を簡単に扱ってみる | taqm&amp;apos;s blog"/><meta property="og:image" content="https://taqm.me/static/site_logo.png"/><meta property="og:description" content="ServerSentEventをNode.jsのライブラリであるexpressから利用しやすくするライブラリを作ったので解説します。"/><meta property="og:site_name" content="taqm.me"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="taqm"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/3bd3ee853585bdba2b55.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3bd3ee853585bdba2b55.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" as="script"/><link rel="preload" href="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" as="script"/><link rel="preload" href="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" as="script"/><style id="__jsx-2615209551">.inner.jsx-2615209551{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:2.5rem;}@media (min-width:640px){.inner.jsx-2615209551{-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;height:4rem;padding-left:1.5rem;padding-right:1.5rem;}}</style></head><body><div id="__next"><header class="jsx-2615209551 border-b border-gray-200 bg-white"><div class="jsx-2615209551 inner max-w-screen-lg mx-auto"><a class="jsx-2615209551 text-xl sm:text-2xl" href="/">taqm&#x27;blog</a></div></header><main class="container py-16"><article class="post-page"><div class="text-sm text-gray-500">2018-06-26</div><h1 class="text-2xl font-bold">ExpressでServer Sent Event (SSE) を簡単に扱ってみる</h1><ul class="flex flex-wrap mt-2"><li class="mr-2 bg-gray-200 hover:bg-gray-300"><a class="block px-2 h-full text-sm" href="/tags/JavaScript">JavaScript</a></li><li class="mr-2 bg-gray-200 hover:bg-gray-300"><a class="block px-2 h-full text-sm" href="/tags/Node.js">Node.js</a></li></ul><div class="mt-10"><h2 class="heading lv-2">概要</h2>
<p class="paragraph">「暇だし簡単なチャットでも作ってみようかなー」と思い
車輪の再発明とわかりつつ、ライブラリっぽいものを作ってみました。</p>
<h3 class="heading lv-3">Server Sent Event(SSE)ってなに</h3>
<p class="paragraph">すごく大雑把に言うと
「コネクションを張りっぱなしにして、必要な時にメッセージ送信を行う仕組み」です。</p>
<p class="paragraph">これだけを聞くとWebSocketと一緒なのかな？と思いますが、
SSEは<strong>サーバ → クライアント</strong>への一方通行となっています。</p>
<p class="paragraph">クライアントはSSEのエンドポイントへ接続しレスポンスを待つのではなく、
ソケットをそのままlistenし続け、サーバサイドでなにかしらPushしたいタイミングで、
クライアント側へデータを送信し処理を行います。</p>
<p class="paragraph">とても省略しましたが、とてもシンプルな仕組みであり
、
HTTP通信に親しみのある方なら、とっつきやすいと思います。</p>
<h4 class="heading lv-4">参考になった記事</h4>
<ul class="list unordered">
<li><a href="https://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/" class="anchor" rel="noopener noreferrer" target="_blank">https://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/</a></li>
<li><a href="https://uhyohyo.net/javascript/13_2.html" class="anchor" rel="noopener noreferrer" target="_blank">https://uhyohyo.net/javascript/13_2.html</a></li>
<li><a href="https://www.slideshare.net/mawarimichi/push-37869433" class="anchor" rel="noopener noreferrer" target="_blank">https://www.slideshare.net/mawarimichi/push-37869433</a></li>
</ul>
<h2 class="heading lv-2">環境</h2>
<p class="paragraph">型定義が大好きなので、TypeScriptを使っています</p>
<h2 class="heading lv-2">完成したもの</h2>
<p class="paragraph">ソースコードは<a href="https://github.com/taqm/express-sse-middleware" class="anchor" rel="noopener noreferrer" target="_blank">こちら</a></p>
<p class="paragraph">完全にドキュメントが面倒になったパターンなので、
READMEなどはあとでちゃんと整備します</p>
<h2 class="heading lv-2">使い方</h2>
<p class="paragraph">まずはインストール
<code class="code">npm install express-sse-middleware</code>
yarn を使う場合は
<code class="code">yarn add express-sse-middleware</code></p>
<p class="paragraph">README通りですが一番シンプルな使い方が↓</p>
<div class="remark-highlight"><pre class="language-javascript pre"><code class="language-javascript code"><span class="token keyword module">import</span> <span class="token imports">express</span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> sseMiddleware <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'express-sse-middleware'</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>sseMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/path'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sentMsg <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token method function property-access">sse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">sentMsg</span><span class="token punctuation">(</span><span class="token known-class-name class-name">String</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// １秒おきに数値を送信する</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph"><code class="code">res.sse()</code>の戻り値である<code class="code">sentMsg</code>を実行するタイミングで
クライアントへと値が送信されます。</p>
<p class="paragraph">実装は60行程度なので非常にシンプルに作っています。
ぜひソースコードを見てみてください。</p>
<h2 class="heading lv-2">demo</h2>
<p class="paragraph"><del><a href="https://github.com/taqm/express-sse-sample" class="anchor" rel="noopener noreferrer" target="_blank">サンプルプロジェクトのソース</a></del>
<del>Herokuで実際に動かしています。</del></p>
<p class="paragraph">こちら閉鎖しました</p>
<h2 class="heading lv-2">感想</h2>
<p class="paragraph">仕様を完全に実装できてはいませんが、簡単に作ることができました。
むしろTypeScriptでNpmモジュールを作ったのが初めてなので
そちらのほうが大変だったかも・・・</p>
<p class="paragraph">SSEに関しては、Spring5でも採用されていたり
リアクティブプログラミングと相性が良かったりするので、今後は主流の技術になるかも知れません。</p>
<p class="paragraph">ちなみに、とりあえず動かしてみたかった系の実装なので
もし危険な処理や、他にベストプラクティスがあるのであれば、ぜひ教えてください！</p></div></article></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":"{\"slug\":\"sse_express\",\"title\":\"ExpressでServer Sent Event (SSE) を簡単に扱ってみる\",\"publishedAt\":\"2018-06-26T10:38:36.000Z\",\"description\":\"ServerSentEventをNode.jsのライブラリであるexpressから利用しやすくするライブラリを作ったので解説します。\",\"tags\":[\"JavaScript\",\"Node.js\"]}","content":"\u003ch2 class=\"heading lv-2\"\u003e概要\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e「暇だし簡単なチャットでも作ってみようかなー」と思い\n車輪の再発明とわかりつつ、ライブラリっぽいものを作ってみました。\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003eServer Sent Event(SSE)ってなに\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003eすごく大雑把に言うと\n「コネクションを張りっぱなしにして、必要な時にメッセージ送信を行う仕組み」です。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eこれだけを聞くとWebSocketと一緒なのかな？と思いますが、\nSSEは\u003cstrong\u003eサーバ → クライアント\u003c/strong\u003eへの一方通行となっています。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eクライアントはSSEのエンドポイントへ接続しレスポンスを待つのではなく、\nソケットをそのままlistenし続け、サーバサイドでなにかしらPushしたいタイミングで、\nクライアント側へデータを送信し処理を行います。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eとても省略しましたが、とてもシンプルな仕組みであり\n、\nHTTP通信に親しみのある方なら、とっつきやすいと思います。\u003c/p\u003e\n\u003ch4 class=\"heading lv-4\"\u003e参考になった記事\u003c/h4\u003e\n\u003cul class=\"list unordered\"\u003e\n\u003cli\u003e\u003ca href=\"https://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://uhyohyo.net/javascript/13_2.html\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://uhyohyo.net/javascript/13_2.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.slideshare.net/mawarimichi/push-37869433\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://www.slideshare.net/mawarimichi/push-37869433\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 class=\"heading lv-2\"\u003e環境\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e型定義が大好きなので、TypeScriptを使っています\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e完成したもの\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eソースコードは\u003ca href=\"https://github.com/taqm/express-sse-middleware\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eこちら\u003c/a\u003e\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e完全にドキュメントが面倒になったパターンなので、\nREADMEなどはあとでちゃんと整備します\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e使い方\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eまずはインストール\n\u003ccode class=\"code\"\u003enpm install express-sse-middleware\u003c/code\u003e\nyarn を使う場合は\n\u003ccode class=\"code\"\u003eyarn add express-sse-middleware\u003c/code\u003e\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eREADME通りですが一番シンプルな使い方が↓\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-javascript pre\"\u003e\u003ccode class=\"language-javascript code\"\u003e\u003cspan class=\"token keyword module\"\u003eimport\u003c/span\u003e \u003cspan class=\"token imports\"\u003eexpress\u003c/span\u003e \u003cspan class=\"token keyword module\"\u003efrom\u003c/span\u003e \u003cspan class=\"token string\"\u003e'express'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword module\"\u003eimport\u003c/span\u003e \u003cspan class=\"token imports\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e sseMiddleware \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token keyword module\"\u003efrom\u003c/span\u003e \u003cspan class=\"token string\"\u003e'express-sse-middleware'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\napp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003euse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esseMiddleware\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\napp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eget\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/path'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ereq\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e res\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e sentMsg \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e res\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003esse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e count \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003esetInterval\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003esentMsg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token known-class-name class-name\"\u003eString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ecount\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// １秒おきに数値を送信する\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\napp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elisten\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e3000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003e\u003ccode class=\"code\"\u003eres.sse()\u003c/code\u003eの戻り値である\u003ccode class=\"code\"\u003esentMsg\u003c/code\u003eを実行するタイミングで\nクライアントへと値が送信されます。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e実装は60行程度なので非常にシンプルに作っています。\nぜひソースコードを見てみてください。\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003edemo\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e\u003cdel\u003e\u003ca href=\"https://github.com/taqm/express-sse-sample\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eサンプルプロジェクトのソース\u003c/a\u003e\u003c/del\u003e\n\u003cdel\u003eHerokuで実際に動かしています。\u003c/del\u003e\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eこちら閉鎖しました\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e感想\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e仕様を完全に実装できてはいませんが、簡単に作ることができました。\nむしろTypeScriptでNpmモジュールを作ったのが初めてなので\nそちらのほうが大変だったかも・・・\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eSSEに関しては、Spring5でも採用されていたり\nリアクティブプログラミングと相性が良かったりするので、今後は主流の技術になるかも知れません。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eちなみに、とりあえず動かしてみたかった系の実装なので\nもし危険な処理や、他にベストプラクティスがあるのであれば、ぜひ教えてください！\u003c/p\u003e"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"sse_express"},"buildId":"2TeC_BqFkmcRD1K9YUrqZ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-51ce6eb9ed73aacaf515.js"></script><script src="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" async=""></script><script src="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" async=""></script><script src="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_buildManifest.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_ssgManifest.js" async=""></script></body></html>