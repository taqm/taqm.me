<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-X38HKLJWTQ"></script><script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X38HKLJWTQ', { page_path: window.location.pathname, }); </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="robots" content="nofollow noindex"/><title>Go言語でServerSentEvents(SSE) | taqm&#x27;s blog</title><meta name="keywords" content="Golang"/><meta name="description" content="ServerSentEventをGo言語から扱って見たシンプルな例を解説します。"/><meta property="og:url" content="https://taqm.me/posts/sse_golang"/><meta property="og:type" content="article"/><meta property="og:title" content="Go言語でServerSentEvents(SSE) | taqm&amp;apos;s blog"/><meta property="og:image" content="https://taqm.me/static/site_logo.png"/><meta property="og:description" content="ServerSentEventをGo言語から扱って見たシンプルな例を解説します。"/><meta property="og:site_name" content="taqm.me"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="taqm"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/3bd3ee853585bdba2b55.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3bd3ee853585bdba2b55.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" as="script"/><link rel="preload" href="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" as="script"/><link rel="preload" href="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" as="script"/><style id="__jsx-2615209551">.inner.jsx-2615209551{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:2.5rem;}@media (min-width:640px){.inner.jsx-2615209551{-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;height:4rem;padding-left:1.5rem;padding-right:1.5rem;}}</style></head><body><div id="__next"><header class="jsx-2615209551 border-b border-gray-200 bg-white"><div class="jsx-2615209551 inner max-w-screen-lg mx-auto"><a class="jsx-2615209551 text-xl sm:text-2xl" href="/">taqm&#x27;blog</a></div></header><main class="container py-16"><article class="post-page"><div class="text-sm text-gray-500">2018-10-16</div><h1 class="text-2xl font-bold">Go言語でServerSentEvents(SSE)</h1><ul class="flex flex-wrap mt-2"><li class="mr-2 bg-gray-200 hover:bg-gray-300"><a class="block px-2 h-full text-sm" href="/tags/Golang">Golang</a></li></ul><div class="mt-10"><h2 class="heading lv-2">はじめに</h2>
<p class="paragraph">タイトルの通りGo言語でServerSentEvent(以下SSE)を実装してみます。</p>
<p class="paragraph">まずSSEとはなあに？って方はこちらが参考になります</p>
<ul class="list unordered">
<li><a href="https://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/" class="anchor" rel="noopener noreferrer" target="_blank">https://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/</a></li>
<li><a href="http://labs.gree.jp/blog/2014/08/11070/" class="anchor" rel="noopener noreferrer" target="_blank">http://labs.gree.jp/blog/2014/08/11070/</a></li>
<li><a href="https://www.w3.org/TR/eventsource/" class="anchor" rel="noopener noreferrer" target="_blank">https://www.w3.org/TR/eventsource/</a></li>
</ul>
<p class="paragraph">正直「WebSocketで良くない？」って雰囲気のある技術ですが、
仕様がシンプルなので好きな技術なのです:smirk_cat:</p>
<h2 class="heading lv-2">コード</h2>
<p class="paragraph">まずはプロジェクト構成</p>
<div class="remark-highlight"><pre class="language-unknown pre"><code class="language-unknown code">├── main.go
└── static
    └── index.html</code></pre></div>
<p class="paragraph">とてもシンプルです
実際の各ファイルの中身を見ていきます</p>
<h3 class="heading lv-3">./main.go</h3>
<div class="has-filename"><div class="filename">./main.go</div><pre class="language-go pre"><code class="language-go code"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">sse</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flusher<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Flusher<span class="token punctuation">)</span>

	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/event-stream"</span><span class="token punctuation">)</span>
	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span> <span class="token string">"no-cache"</span><span class="token punctuation">)</span>
	w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">,</span> <span class="token string">"keep-alive"</span><span class="token punctuation">)</span>

	<span class="token comment">// 1秒おきにデータを流す</span>
	t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> t<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		cnt <span class="token operator">:=</span> <span class="token number">1</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&#x3C;-</span>t<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
				fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"data: %d\n\n"</span><span class="token punctuation">,</span> cnt<span class="token punctuation">)</span>
				cnt<span class="token operator">++</span>
				flusher<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">&#x3C;-</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"コネクションが閉じました"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	dir <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Dir</span><span class="token punctuation">(</span><span class="token string">"./static"</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/event"</span><span class="token punctuation">,</span> sse<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> http<span class="token punctuation">.</span><span class="token function">FileServer</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h4 class="heading lv-4">解説</h4>
<p class="paragraph"><code class="code">main</code>関数については特に説明は不要かと思いますので
<code class="code">func sse(...)</code>について処理を追って説明をしていきます。</p>
<h5 class="heading lv-5">レスポンスヘッダーの設定</h5>
<div class="remark-highlight"><pre class="language-go pre"><code class="language-go code">w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">,</span> <span class="token string">"text/event-stream"</span><span class="token punctuation">)</span>
w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Cache-Control"</span><span class="token punctuation">,</span> <span class="token string">"no-cache"</span><span class="token punctuation">)</span>
w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Connection"</span><span class="token punctuation">,</span> <span class="token string">"keep-alive"</span><span class="token punctuation">)</span>
</code></pre></div>
<p class="paragraph">まずはレスポンスヘッダーに必要な項目を設定します。
ここについては見慣れたコードになりますね。</p>
<h5 class="heading lv-5">Flusherへのキャスト</h5>
<div class="remark-highlight"><pre class="language-go pre"><code class="language-go code">flusher<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> w<span class="token punctuation">.</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>Flusher<span class="token punctuation">)</span>
</code></pre></div>
<p class="paragraph">ここが一番のキモです！:point_up:
<code class="code">http.ResponseWriter</code>を<code class="code">http.Flusher</code>へキャストします。
<code class="code">http.Flusher</code>とはResponseWritersに実装されたインタフェースで、
バッファしているデータをクライアントへフラッシュするものです。</p>
<p class="paragraph">後述しますが<code class="code">flusher.Flush()</code>をすることで、
書き込んだ内容をすぐにクライアントサイドへ送信することができます。</p>
<h5 class="heading lv-5">イベントの送信</h5>
<div class="remark-highlight"><pre class="language-go pre"><code class="language-go code">t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token keyword">defer</span> t<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cnt <span class="token operator">:=</span> <span class="token number">1</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token operator">&#x3C;-</span>t<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"data: %d\n\n"</span><span class="token punctuation">,</span> cnt<span class="token punctuation">)</span>
			cnt<span class="token operator">++</span>
			flusher<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div>
<p class="paragraph">１秒おきにカウントアップした値を送信しています。
<code class="code">fmt.Fprintf</code>で書き込んだ後に、先程用意した<code class="code">flusher.Flush()</code>を読んであげましょう。
こうすることで書き込んだ内容がクライアントへ送信されます。
<code class="code">data: XX\n\n</code>というのはSSEの仕様であり、
他にも<code class="code">event</code>や<code class="code">id</code>を設定することで柔軟なイベント駆動が可能になるのですが、
ここではシンプルに<code class="code">data</code>だけを送信します。</p>
<h4 class="heading lv-4">クローズ処理</h4>
<div class="remark-highlight"><pre class="language-go pre"><code class="language-go code"><span class="token comment">// notify := w.(http.CloseNotifier).CloseNotify()</span>
<span class="token comment">// &#x3C;-notify</span>
<span class="token operator">&#x3C;-</span>r<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"コネクションが閉じました"</span><span class="token punctuation">)</span>
</code></pre></div>
<p class="paragraph"><del>ここでは<code class="code">http.ResponseWriter</code>を<code class="code">http.CloseNotifier</code>へとキャストします。
キャスト後に<code class="code">CloseNotify()</code>の戻り値で</del>
コネクションが閉じたかどうかが<code class="code">chan bool</code>返却されるため取得します。</p>
<p class="paragraph"><strong>-- 2020/03/05 追記 --</strong>
<code class="code">CloseNotifier</code>はだいぶ前に非推奨になったということなので
<code class="code">r.Context().Done()</code> を利用してコネクションが閉じたかを判定するほうが良いです。
<strong>-- 追記ここまで --</strong></p>
<p class="paragraph">あとはこのチャンネルを監視し処理を止めておくことでSSE実装完了です！
ちなみに前述した<code class="code">Ticker</code>は<code class="code">defer t.Stop()</code>しているので勝手に止まってくれます。</p>
<h3 class="heading lv-3">./static/index.html</h3>
<p class="paragraph">用意したエンドポイントへつなぐ部分です。
headタグなど書いても仕方ないので、bodyの中身だけ抜粋します。</p>
<div class="has-filename"><div class="filename">./static/index.html&#x3C;body></div><pre class="language-html pre"><code class="language-html code"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>count: <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cnt<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>span</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> ev <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">'/event'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ev<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      cnt<span class="token punctuation">.</span><span class="token property-access">textContent</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
</code></pre></div>
<p class="paragraph"><code class="code">EventSource</code>といったものを利用することで、
簡単に先程用意したエンドポイントへ接続することができます。</p>
<h2 class="heading lv-2">まとめ</h2>
<p class="paragraph">SSE自体がHTTPの簡単な仕様の上で成り立っているので、
標準ライブラリのみで簡単に実装ができました。</p>
<p class="paragraph">実際に利用する場合には、
<code class="code">flusher</code>をハンドラ外で管理したり、外部のイベントストリームを監視したりと、
色々とロジックが必要になりますが、SSEの実装部分としてはこれだけです。</p>
<p class="paragraph">簡単にサーバーサイドプッシュを実装したいときには
有力な候補になるかなとおもいます:relaxed:</p>
<p class="paragraph">おしまい</p></div></article></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":"{\"slug\":\"sse_golang\",\"title\":\"Go言語でServerSentEvents(SSE)\",\"publishedAt\":\"2018-10-16T01:38:26.000Z\",\"description\":\"ServerSentEventをGo言語から扱って見たシンプルな例を解説します。\",\"tags\":[\"Golang\"]}","content":"\u003ch2 class=\"heading lv-2\"\u003eはじめに\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eタイトルの通りGo言語でServerSentEvent(以下SSE)を実装してみます。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eまずSSEとはなあに？って方はこちらが参考になります\u003c/p\u003e\n\u003cul class=\"list unordered\"\u003e\n\u003cli\u003e\u003ca href=\"https://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://www.webprofessional.jp/real-time-apps-websockets-server-sent-events/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://labs.gree.jp/blog/2014/08/11070/\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttp://labs.gree.jp/blog/2014/08/11070/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.w3.org/TR/eventsource/\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://www.w3.org/TR/eventsource/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp class=\"paragraph\"\u003e正直「WebSocketで良くない？」って雰囲気のある技術ですが、\n仕様がシンプルなので好きな技術なのです:smirk_cat:\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003eコード\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eまずはプロジェクト構成\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown pre\"\u003e\u003ccode class=\"language-unknown code\"\u003e├── main.go\n└── static\n    └── index.html\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eとてもシンプルです\n実際の各ファイルの中身を見ていきます\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003e./main.go\u003c/h3\u003e\n\u003cdiv class=\"has-filename\"\u003e\u003cdiv class=\"filename\"\u003e./main.go\u003c/div\u003e\u003cpre class=\"language-go pre\"\u003e\u003ccode class=\"language-go code\"\u003e\u003cspan class=\"token keyword\"\u003epackage\u003c/span\u003e main\n\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"fmt\"\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"log\"\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"net/http\"\u003c/span\u003e\n\t\u003cspan class=\"token string\"\u003e\"time\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003esse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eResponseWriter\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e r \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRequest\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tflusher\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003e_\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e w\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eFlusher\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\tw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Content-Type\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"text/event-stream\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\tw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Cache-Control\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"no-cache\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\tw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Connection\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"keep-alive\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\t\u003cspan class=\"token comment\"\u003e// 1秒おきにデータを流す\u003c/span\u003e\n\tt \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eNewTicker\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003edefer\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eStop\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003ego\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\tcnt \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\t\u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;-\u003c/span\u003et\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eC\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\t\t\tfmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"data: %d\\n\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cnt\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\tcnt\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\t\t\t\tflusher\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFlush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\u003cspan class=\"token operator\"\u003e\u0026#x3C;-\u003c/span\u003er\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDone\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\tlog\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"コネクションが閉じました\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tdir \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDir\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"./static\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandleFunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/event\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sse\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHandle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"/\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e http\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFileServer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edir\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\thttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eListenAndServe\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\":8080\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch4 class=\"heading lv-4\"\u003e解説\u003c/h4\u003e\n\u003cp class=\"paragraph\"\u003e\u003ccode class=\"code\"\u003emain\u003c/code\u003e関数については特に説明は不要かと思いますので\n\u003ccode class=\"code\"\u003efunc sse(...)\u003c/code\u003eについて処理を追って説明をしていきます。\u003c/p\u003e\n\u003ch5 class=\"heading lv-5\"\u003eレスポンスヘッダーの設定\u003c/h5\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go pre\"\u003e\u003ccode class=\"language-go code\"\u003ew\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Content-Type\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"text/event-stream\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Cache-Control\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"no-cache\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nw\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eSet\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"Connection\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"keep-alive\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eまずはレスポンスヘッダーに必要な項目を設定します。\nここについては見慣れたコードになりますね。\u003c/p\u003e\n\u003ch5 class=\"heading lv-5\"\u003eFlusherへのキャスト\u003c/h5\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go pre\"\u003e\u003ccode class=\"language-go code\"\u003eflusher\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003e_\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e w\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ehttp\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eFlusher\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eここが一番のキモです！:point_up:\n\u003ccode class=\"code\"\u003ehttp.ResponseWriter\u003c/code\u003eを\u003ccode class=\"code\"\u003ehttp.Flusher\u003c/code\u003eへキャストします。\n\u003ccode class=\"code\"\u003ehttp.Flusher\u003c/code\u003eとはResponseWritersに実装されたインタフェースで、\nバッファしているデータをクライアントへフラッシュするものです。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e後述しますが\u003ccode class=\"code\"\u003eflusher.Flush()\u003c/code\u003eをすることで、\n書き込んだ内容をすぐにクライアントサイドへ送信することができます。\u003c/p\u003e\n\u003ch5 class=\"heading lv-5\"\u003eイベントの送信\u003c/h5\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go pre\"\u003e\u003ccode class=\"language-go code\"\u003et \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eNewTicker\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSecond\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edefer\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eStop\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ego\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\tcnt \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n\t\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"token keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x3C;-\u003c/span\u003et\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eC\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n\t\t\tfmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFprintf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ew\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"data: %d\\n\\n\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cnt\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\tcnt\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\n\t\t\tflusher\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eFlush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\t\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003e１秒おきにカウントアップした値を送信しています。\n\u003ccode class=\"code\"\u003efmt.Fprintf\u003c/code\u003eで書き込んだ後に、先程用意した\u003ccode class=\"code\"\u003eflusher.Flush()\u003c/code\u003eを読んであげましょう。\nこうすることで書き込んだ内容がクライアントへ送信されます。\n\u003ccode class=\"code\"\u003edata: XX\\n\\n\u003c/code\u003eというのはSSEの仕様であり、\n他にも\u003ccode class=\"code\"\u003eevent\u003c/code\u003eや\u003ccode class=\"code\"\u003eid\u003c/code\u003eを設定することで柔軟なイベント駆動が可能になるのですが、\nここではシンプルに\u003ccode class=\"code\"\u003edata\u003c/code\u003eだけを送信します。\u003c/p\u003e\n\u003ch4 class=\"heading lv-4\"\u003eクローズ処理\u003c/h4\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go pre\"\u003e\u003ccode class=\"language-go code\"\u003e\u003cspan class=\"token comment\"\u003e// notify := w.(http.CloseNotifier).CloseNotify()\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// \u0026#x3C;-notify\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e\u0026#x3C;-\u003c/span\u003er\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eDone\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nlog\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"コネクションが閉じました\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003e\u003cdel\u003eここでは\u003ccode class=\"code\"\u003ehttp.ResponseWriter\u003c/code\u003eを\u003ccode class=\"code\"\u003ehttp.CloseNotifier\u003c/code\u003eへとキャストします。\nキャスト後に\u003ccode class=\"code\"\u003eCloseNotify()\u003c/code\u003eの戻り値で\u003c/del\u003e\nコネクションが閉じたかどうかが\u003ccode class=\"code\"\u003echan bool\u003c/code\u003e返却されるため取得します。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e\u003cstrong\u003e-- 2020/03/05 追記 --\u003c/strong\u003e\n\u003ccode class=\"code\"\u003eCloseNotifier\u003c/code\u003eはだいぶ前に非推奨になったということなので\n\u003ccode class=\"code\"\u003er.Context().Done()\u003c/code\u003e を利用してコネクションが閉じたかを判定するほうが良いです。\n\u003cstrong\u003e-- 追記ここまで --\u003c/strong\u003e\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eあとはこのチャンネルを監視し処理を止めておくことでSSE実装完了です！\nちなみに前述した\u003ccode class=\"code\"\u003eTicker\u003c/code\u003eは\u003ccode class=\"code\"\u003edefer t.Stop()\u003c/code\u003eしているので勝手に止まってくれます。\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003e./static/index.html\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003e用意したエンドポイントへつなぐ部分です。\nheadタグなど書いても仕方ないので、bodyの中身だけ抜粋します。\u003c/p\u003e\n\u003cdiv class=\"has-filename\"\u003e\u003cdiv class=\"filename\"\u003e./static/index.html\u0026#x3C;body\u003e\u003c/div\u003e\u003cpre class=\"language-html pre\"\u003e\u003ccode class=\"language-html code\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003ecount: \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003espan\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eid\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003ecnt\u003cspan class=\"token punctuation\"\u003e\"\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e0\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003espan\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003eh1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n  \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003cspan class=\"token language-javascript\"\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e ev \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eEventSource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'/event'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    ev\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eaddEventListener\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'message'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ee\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      cnt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003etextContent\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003edata\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#x3C;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003e\u003ccode class=\"code\"\u003eEventSource\u003c/code\u003eといったものを利用することで、\n簡単に先程用意したエンドポイントへ接続することができます。\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003eまとめ\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eSSE自体がHTTPの簡単な仕様の上で成り立っているので、\n標準ライブラリのみで簡単に実装ができました。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e実際に利用する場合には、\n\u003ccode class=\"code\"\u003eflusher\u003c/code\u003eをハンドラ外で管理したり、外部のイベントストリームを監視したりと、\n色々とロジックが必要になりますが、SSEの実装部分としてはこれだけです。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e簡単にサーバーサイドプッシュを実装したいときには\n有力な候補になるかなとおもいます:relaxed:\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eおしまい\u003c/p\u003e"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"sse_golang"},"buildId":"2TeC_BqFkmcRD1K9YUrqZ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-51ce6eb9ed73aacaf515.js"></script><script src="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" async=""></script><script src="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" async=""></script><script src="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_buildManifest.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_ssgManifest.js" async=""></script></body></html>