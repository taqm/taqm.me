<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-X38HKLJWTQ"></script><script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X38HKLJWTQ', { page_path: window.location.pathname, }); </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="robots" content="nofollow noindex"/><title>JavaScriptで演算子オーバーロードしてみる(BabelでAST) | taqm&#x27;s blog</title><meta name="keywords" content="JavaScript"/><meta name="description" content="JavaScriptで演算子オーバーロードを実現するためにbabelのプラグインを作成したため解説します。"/><meta property="og:url" content="https://taqm.me/posts/javascript_operator_overload_plugin"/><meta property="og:type" content="article"/><meta property="og:title" content="JavaScriptで演算子オーバーロードしてみる(BabelでAST) | taqm&amp;apos;s blog"/><meta property="og:image" content="https://taqm.me/static/site_logo.png"/><meta property="og:description" content="JavaScriptで演算子オーバーロードを実現するためにbabelのプラグインを作成したため解説します。"/><meta property="og:site_name" content="taqm.me"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="taqm"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/3bd3ee853585bdba2b55.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3bd3ee853585bdba2b55.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" as="script"/><link rel="preload" href="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" as="script"/><link rel="preload" href="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" as="script"/><style id="__jsx-2615209551">.inner.jsx-2615209551{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:2.5rem;}@media (min-width:640px){.inner.jsx-2615209551{-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;height:4rem;padding-left:1.5rem;padding-right:1.5rem;}}</style></head><body><div id="__next"><header class="jsx-2615209551 border-b border-gray-200 bg-white"><div class="jsx-2615209551 inner max-w-screen-lg mx-auto"><a class="jsx-2615209551 text-xl sm:text-2xl" href="/">taqm&#x27;blog</a></div></header><main class="container py-16"><article class="post-page"><div class="text-sm text-gray-500">2019-12-08</div><h1 class="text-2xl font-bold">JavaScriptで演算子オーバーロードしてみる(BabelでAST)</h1><ul class="flex flex-wrap mt-2"><li class="mr-2 bg-gray-200 hover:bg-gray-300"><a class="block px-2 h-full text-sm" href="/tags/JavaScript">JavaScript</a></li></ul><div class="mt-10"><h2 class="heading lv-2">はじめに</h2>
<p class="paragraph">この記事は<a href="https://qiita.com/advent-calendar/2019/javascript" class="anchor" rel="noopener noreferrer" target="_blank">JavaScript Advent Calendar 2019</a>の８日目の記事になります。</p>
<p class="paragraph">実は前々から思っていたことがありました。
それは**「JavaScriptでも演算子オーバーロードしたい...!」** です。
ということで今回やってみました。</p>
<h2 class="heading lv-2">アプローチ方法</h2>
<p class="paragraph">JavaScriptは暗黙的に呼ばれる関数群がいくつかあります(<code class="code">valueOf</code>や<code class="code">toString</code>など)
ただこれらをどういじっても演算子オーバーロードにはなりません。
そこでタグ付きテンプレートリテラルを頑張って解析するかなぁとか考えていたのですが
あまりにも見栄えが悪かったので最終手段であるASTをいじっていく方法に決めました。
今回はbabelのプラグインとして実装します。</p>
<h2 class="heading lv-2">制作物</h2>
<p class="paragraph">先に作ったものを載せます。</p>
<ul class="list unordered">
<li><a href="https://github.com/taqm/babel-plugin-transform-operator-overload" class="anchor" rel="noopener noreferrer" target="_blank">GitHub</a></li>
<li><a href="https://www.npmjs.com/package/babel-plugin-transform-operator-overload" class="anchor" rel="noopener noreferrer" target="_blank">NPM</a></li>
</ul>
<p class="paragraph"><del>npmへ上げたかったのですが
色々とトラブルが重なりログインできないため断念 :crying_cat_face:</del>
publishしました！
プラグイン名が重複していたので少し変わっています。</p>
<p class="paragraph">実際に使うとこんな感じです。</p>
<div class="remark-highlight"><pre class="language-js pre"><code class="language-js code">opol<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> puts <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'&#x3C;&#x3C;'</span><span class="token operator">:</span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  puts <span class="token operator">&#x3C;&#x3C;</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
  <span class="token comment">// => hello world</span>

  <span class="token keyword">class</span> <span class="token class-name">Hoge</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token string">'+'</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">+</span> arg<span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hoge</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hoge</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  puts <span class="token operator">&#x3C;&#x3C;</span> <span class="token punctuation">(</span>a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// => 200</span>
<span class="token punctuation">}</span>
</code></pre></div>
<h2 class="heading lv-2">作ってみる</h2>
<h3 class="heading lv-3">使用ライブラリ</h3>
<p class="paragraph">ASTやbebelプラグインについては良記事がたくさんあるのでここではあまり深くは触れないでおきます。（後ろに書く参考サイト参照
利用しているライブラリは以下です。</p>
<ul class="list unordered">
<li><a href="https://www.npmjs.com/package/@babel/parser" class="anchor" rel="noopener noreferrer" target="_blank">@babel/parser</a> → コードをASTに変換する</li>
<li><a href="https://www.npmjs.com/package/@babel/traverse" class="anchor" rel="noopener noreferrer" target="_blank">@babel/traverse</a> → ASTを操作する</li>
<li><a href="https://www.npmjs.com/package/@babel/types" class="anchor" rel="noopener noreferrer" target="_blank">@babel/types</a> → ASTの要素を操作（作成）する</li>
</ul>
<p class="paragraph">実際はライブラリとして公開する関数に、パース済みの値が渡されてくるためライブラリを使っているという実感はあまりないです。</p>
<h4 class="heading lv-4">小話</h4>
<p class="paragraph">ASTへの変換をウェブを調べると<code class="code">babylon</code>を使っている記事が多いですが、
<code class="code">babylon</code>はすでにアーカイブされており<code class="code">@babel/parser</code>への移行を推奨しています。
気をつけましょう。</p>
<h3 class="heading lv-3">実装</h3>
<p class="paragraph">演算子オーバーロードというくらいなので演算部分にフォーカスを当てることで実現できると考えていました。
実装方針は「演算時の左の要素に<code class="code">+</code>などのプロパティがあった場合はそのプロパティの関数を呼び出す」です。</p>
<p class="paragraph">まずはコードを記載します。</p>
<div class="remark-highlight"><pre class="language-js pre"><code class="language-js code">parentPath<span class="token punctuation">.</span><span class="token method function property-access">traverse</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function"><span class="token maybe-class-name">BinaryExpression</span></span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token property-access">opolMarked</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> operator <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> leftId <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> rightId <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token method function property-access">identifier</span><span class="token punctuation">(</span><span class="token string">'right'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ここで追加するBinaryExpressionも処理の対象となってしまうため</span>
    <span class="token comment">// 印をつけて処理を行わないようにする</span>
    original<span class="token punctuation">.</span><span class="token property-access">opolMarked</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> leftOp <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token method function property-access">memberExpression</span><span class="token punctuation">(</span>leftId<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token method function property-access">stringLiteral</span><span class="token punctuation">(</span>operator<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> overloaded <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token method function property-access">callExpression</span><span class="token punctuation">(</span>leftOp<span class="token punctuation">,</span> <span class="token punctuation">[</span>rightId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> original <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token method function property-access">binaryExpression</span><span class="token punctuation">(</span>operator<span class="token punctuation">,</span> leftId<span class="token punctuation">,</span> rightId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> fnc <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token method function property-access">callExpression</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token method function property-access">arrowFunctionExpression</span><span class="token punctuation">(</span><span class="token punctuation">[</span>leftId<span class="token punctuation">,</span> rightId<span class="token punctuation">]</span><span class="token punctuation">,</span>
        t<span class="token punctuation">.</span><span class="token method function property-access">conditionalExpression</span><span class="token punctuation">(</span>leftOp<span class="token punctuation">,</span> overloaded<span class="token punctuation">,</span> original<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>left<span class="token punctuation">,</span> right<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div>
<p class="paragraph">この<code class="code">BinaryExpression</code>というのが<code class="code">+</code>や<code class="code">&#x3C;</code>などの演算を示すものです。</p>
<div class="remark-highlight"><pre class="language-js pre"><code class="language-js code"><span class="token string">"expression"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"BinaryExpression"</span><span class="token punctuation">,</span>
    <span class="token string">"left"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
      <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"a"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"operator"</span><span class="token operator">:</span> <span class="token string">"+"</span><span class="token punctuation">,</span>
      <span class="token string">"right"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token operator">:</span> <span class="token string">"Identifier"</span><span class="token punctuation">,</span>
       <span class="token string">" name"</span><span class="token operator">:</span> <span class="token string">"b"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div>
<div class="has-filename"><div class="filename">変換前</div><pre class="language-js pre"><code class="language-js code">a <span class="token operator">+</span> b<span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph">↓</p>
<div class="has-filename"><div class="filename">変換後</div><pre class="language-js pre"><code class="language-js code"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> right</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> left<span class="token punctuation">[</span><span class="token string">'+'</span><span class="token punctuation">]</span> <span class="token operator">?</span> left<span class="token punctuation">[</span><span class="token string">'+'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span> <span class="token operator">:</span> left <span class="token operator">+</span> right<span class="token punctuation">)</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph">いきなり読みづらいコードが現れましたね。
↑でも触れましたがやっていることは<strong>左の要素</strong>に<strong>演算子</strong>と同じ記号のプロパティが存在するのなら
そのプロパティを右の要素を引数として呼び出し、
プロパティが存在しないのであれば通常通りの演算を行うというものです。
(<code class="code">left['+']</code>が<code class="code">undefined</code>ではない → オーバーロードしているという割り切り)</p>
<p class="paragraph">なぜ複雑に見える即時関数にする必要が？と感じると思いますがこれはとある問題があるからです。
<code class="code">a + b</code> 程度の式ならいいですが <code class="code">a() + b()</code>という式になった場合に計算結果を使い回す必要が出てきます。
事前に計算を行い変数に入れるというのもありなのですが、変数名の重複などの考慮が面倒だったので即時関数の引数とすることでスコープの狭い変数として計算結果を渡すことで解決しています。</p>
<h5 class="heading lv-5">ちなみに</h5>
<blockquote>
<p class="paragraph">if (path.node.opolMarked) return;</p>
</blockquote>
<p class="paragraph">という記述がありますがこれがないと追加された <code class="code">left + right</code> に対して
同じ処理が走りstackoverflowを起こしてしまいます!</p>
<h3 class="heading lv-3">完成か？</h3>
<p class="paragraph">動きだけを見ると完成かと思いました。
ですが...流石にコード量が増えすぎますし、すべてのコードにこれを適用してしまうととんでもないことになってしまいます。
なので今回は特定の文字列のラベルがついたブロック内でのみ↑の処理を行うようにしました。
こうすることで最小限のコードの増加で済みそうです。</p>
<div class="remark-highlight"><pre class="language-js pre"><code class="language-js code">opol<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... このブロック内のみ変換処理を行う。</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-js pre"><code class="language-js code">visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function"><span class="token maybe-class-name">LabeledStatement</span></span><span class="token punctuation">(</span><span class="token parameter">parentPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>parentPath<span class="token punctuation">.</span><span class="token property-access">node</span><span class="token punctuation">.</span><span class="token property-access">label</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">!==</span> <span class="token string">'opol'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre></div>
<h2 class="heading lv-2">本当の完成</h2>
<p class="paragraph">これで完成！</p>
<div class="remark-highlight"><pre class="language-js pre"><code class="language-js code"><span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">[</span><span class="token string">'&#x3C;&#x3C;'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

opol<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  a <span class="token operator">&#x3C;&#x3C;</span> <span class="token number">1</span><span class="token punctuation">;</span>
  a <span class="token operator">&#x3C;&#x3C;</span> <span class="token number">2</span><span class="token punctuation">;</span>
  a <span class="token operator">&#x3C;&#x3C;</span> <span class="token number">3</span><span class="token punctuation">;</span>
  puts <span class="token operator">&#x3C;&#x3C;</span> a<span class="token punctuation">;</span>
  <span class="token comment">// => [1,2,3]</span>

  <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">'==='</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  puts <span class="token operator">&#x3C;&#x3C;</span> <span class="token punctuation">(</span>a <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&#x26;&#x26;</span> a <span class="token operator">===</span> <span class="token number">2</span> <span class="token operator">&#x26;&#x26;</span> a <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// true</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p class="paragraph">これできれいな構文や気味の悪い構文を自由にかけるようになりました。</p>
<h3 class="heading lv-3">課題</h3>
<p class="paragraph">ESLintや型の解決が一切行われないので
知らない人が見ると一体何が起きているのかわからない状態となります...:grimacing:
もちろんですがTypeScriptでは使えません。</p>
<p class="paragraph"><del>あとテストも書けてません。（動作確認も怪しいです）</del> テスト書きました
課題まみれです。</p>
<h2 class="heading lv-2">最後に</h2>
<p class="paragraph">長年の夢だったJavaScriptでの演算子オーバーロードを実現することができました。
正直実用的ではないですが、普段の業務では扱わないような技術で頭の体操になりますね。
本当はもっといろんなことをやりたかったのですが間に合わなかったので少しずつ機能を足していければと思います。(npmへもそのうち上げたいです）</p>
<p class="paragraph">そして、今回はbabel経由でASTの操作を行いました。
ASTを扱うのはハードルが高いように感じますがとても簡単なのでぜひ皆さんも触ってみてください。</p>
<hr>
<p class="paragraph">おしまい</p>
<h2 class="heading lv-2">参考サイト</h2>
<ul class="list unordered">
<li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/ja/plugin-handbook.md" class="anchor" rel="noopener noreferrer" target="_blank">https://github.com/jamiebuilds/babel-handbook/blob/master/translations/ja/plugin-handbook.md</a></li>
<li><a href="https://efcl.info/2019/12/03/dive-to-ast/" class="anchor" rel="noopener noreferrer" target="_blank">https://efcl.info/2019/12/03/dive-to-ast/</a></li>
<li><a href="https://sakura.io/blog/2017/12/13/babel-plugins/" class="anchor" rel="noopener noreferrer" target="_blank">https://sakura.io/blog/2017/12/13/babel-plugins/</a></li>
</ul></div></article></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":"{\"slug\":\"javascript_operator_overload_plugin\",\"title\":\"JavaScriptで演算子オーバーロードしてみる(BabelでAST)\",\"publishedAt\":\"2019-12-08T02:18:34.000Z\",\"description\":\"JavaScriptで演算子オーバーロードを実現するためにbabelのプラグインを作成したため解説します。\",\"tags\":[\"JavaScript\"]}","content":"\u003ch2 class=\"heading lv-2\"\u003eはじめに\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eこの記事は\u003ca href=\"https://qiita.com/advent-calendar/2019/javascript\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eJavaScript Advent Calendar 2019\u003c/a\u003eの８日目の記事になります。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e実は前々から思っていたことがありました。\nそれは**「JavaScriptでも演算子オーバーロードしたい...!」** です。\nということで今回やってみました。\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003eアプローチ方法\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eJavaScriptは暗黙的に呼ばれる関数群がいくつかあります(\u003ccode class=\"code\"\u003evalueOf\u003c/code\u003eや\u003ccode class=\"code\"\u003etoString\u003c/code\u003eなど)\nただこれらをどういじっても演算子オーバーロードにはなりません。\nそこでタグ付きテンプレートリテラルを頑張って解析するかなぁとか考えていたのですが\nあまりにも見栄えが悪かったので最終手段であるASTをいじっていく方法に決めました。\n今回はbabelのプラグインとして実装します。\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e制作物\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e先に作ったものを載せます。\u003c/p\u003e\n\u003cul class=\"list unordered\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/taqm/babel-plugin-transform-operator-overload\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eGitHub\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.npmjs.com/package/babel-plugin-transform-operator-overload\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eNPM\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp class=\"paragraph\"\u003e\u003cdel\u003enpmへ上げたかったのですが\n色々とトラブルが重なりログインできないため断念 :crying_cat_face:\u003c/del\u003e\npublishしました！\nプラグイン名が重複していたので少し変わっています。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e実際に使うとこんな感じです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003eopol\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e puts \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token string\"\u003e'\u0026#x3C;\u0026#x3C;'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003elog\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  puts \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token string\"\u003e'hello world'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// =\u003e hello world\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHoge\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003econstructor\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evalue\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e value\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e'+'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003earg\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evalue\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e arg\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHoge\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e b \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eHoge\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e100\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  puts \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e b\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// =\u003e 200\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 class=\"heading lv-2\"\u003e作ってみる\u003c/h2\u003e\n\u003ch3 class=\"heading lv-3\"\u003e使用ライブラリ\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003eASTやbebelプラグインについては良記事がたくさんあるのでここではあまり深くは触れないでおきます。（後ろに書く参考サイト参照\n利用しているライブラリは以下です。\u003c/p\u003e\n\u003cul class=\"list unordered\"\u003e\n\u003cli\u003e\u003ca href=\"https://www.npmjs.com/package/@babel/parser\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003e@babel/parser\u003c/a\u003e → コードをASTに変換する\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.npmjs.com/package/@babel/traverse\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003e@babel/traverse\u003c/a\u003e → ASTを操作する\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.npmjs.com/package/@babel/types\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003e@babel/types\u003c/a\u003e → ASTの要素を操作（作成）する\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp class=\"paragraph\"\u003e実際はライブラリとして公開する関数に、パース済みの値が渡されてくるためライブラリを使っているという実感はあまりないです。\u003c/p\u003e\n\u003ch4 class=\"heading lv-4\"\u003e小話\u003c/h4\u003e\n\u003cp class=\"paragraph\"\u003eASTへの変換をウェブを調べると\u003ccode class=\"code\"\u003ebabylon\u003c/code\u003eを使っている記事が多いですが、\n\u003ccode class=\"code\"\u003ebabylon\u003c/code\u003eはすでにアーカイブされており\u003ccode class=\"code\"\u003e@babel/parser\u003c/code\u003eへの移行を推奨しています。\n気をつけましょう。\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003e実装\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003e演算子オーバーロードというくらいなので演算部分にフォーカスを当てることで実現できると考えていました。\n実装方針は「演算時の左の要素に\u003ccode class=\"code\"\u003e+\u003c/code\u003eなどのプロパティがあった場合はそのプロパティの関数を呼び出す」です。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eまずはコードを記載します。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003eparentPath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etraverse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003e\u003cspan class=\"token maybe-class-name\"\u003eBinaryExpression\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003epath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003enode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eopolMarked\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e left\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e right\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e operator \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e path\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003enode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e leftId \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eidentifier\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'left'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e rightId \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eidentifier\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'right'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// ここで追加するBinaryExpressionも処理の対象となってしまうため\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 印をつけて処理を行わないようにする\u003c/span\u003e\n    original\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eopolMarked\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e leftOp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ememberExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eleftId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estringLiteral\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eoperator\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e overloaded \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecallExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eleftOp\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003erightId\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e original \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ebinaryExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eoperator\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e leftId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rightId\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e fnc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ecallExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n      t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003earrowFunctionExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eleftId\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rightId\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        t\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003econditionalExpression\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eleftOp\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e overloaded\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e original\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003eleft\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e right\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eこの\u003ccode class=\"code\"\u003eBinaryExpression\u003c/code\u003eというのが\u003ccode class=\"code\"\u003e+\u003c/code\u003eや\u003ccode class=\"code\"\u003e\u0026#x3C;\u003c/code\u003eなどの演算を示すものです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003e\u003cspan class=\"token string\"\u003e\"expression\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"BinaryExpression\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"left\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token string\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Identifier\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string\"\u003e\"name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"a\"\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string\"\u003e\"operator\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"+\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n      \u003cspan class=\"token string\"\u003e\"right\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token string\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"Identifier\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n       \u003cspan class=\"token string\"\u003e\" name\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"b\"\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"has-filename\"\u003e\u003cdiv class=\"filename\"\u003e変換前\u003c/div\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003ea \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e b\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003e↓\u003c/p\u003e\n\u003cdiv class=\"has-filename\"\u003e\u003cdiv class=\"filename\"\u003e変換後\u003c/div\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eleft\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e right\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e left\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'+'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e left\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'+'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eright\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e:\u003c/span\u003e left \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e right\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e b\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eいきなり読みづらいコードが現れましたね。\n↑でも触れましたがやっていることは\u003cstrong\u003e左の要素\u003c/strong\u003eに\u003cstrong\u003e演算子\u003c/strong\u003eと同じ記号のプロパティが存在するのなら\nそのプロパティを右の要素を引数として呼び出し、\nプロパティが存在しないのであれば通常通りの演算を行うというものです。\n(\u003ccode class=\"code\"\u003eleft['+']\u003c/code\u003eが\u003ccode class=\"code\"\u003eundefined\u003c/code\u003eではない → オーバーロードしているという割り切り)\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eなぜ複雑に見える即時関数にする必要が？と感じると思いますがこれはとある問題があるからです。\n\u003ccode class=\"code\"\u003ea + b\u003c/code\u003e 程度の式ならいいですが \u003ccode class=\"code\"\u003ea() + b()\u003c/code\u003eという式になった場合に計算結果を使い回す必要が出てきます。\n事前に計算を行い変数に入れるというのもありなのですが、変数名の重複などの考慮が面倒だったので即時関数の引数とすることでスコープの狭い変数として計算結果を渡すことで解決しています。\u003c/p\u003e\n\u003ch5 class=\"heading lv-5\"\u003eちなみに\u003c/h5\u003e\n\u003cblockquote\u003e\n\u003cp class=\"paragraph\"\u003eif (path.node.opolMarked) return;\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp class=\"paragraph\"\u003eという記述がありますがこれがないと追加された \u003ccode class=\"code\"\u003eleft + right\u003c/code\u003e に対して\n同じ処理が走りstackoverflowを起こしてしまいます!\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003e完成か？\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003e動きだけを見ると完成かと思いました。\nですが...流石にコード量が増えすぎますし、すべてのコードにこれを適用してしまうととんでもないことになってしまいます。\nなので今回は特定の文字列のラベルがついたブロック内でのみ↑の処理を行うようにしました。\nこうすることで最小限のコードの増加で済みそうです。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003eopol\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// ... このブロック内のみ変換処理を行う。\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003evisitor\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003e\u003cspan class=\"token maybe-class-name\"\u003eLabeledStatement\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eparentPath\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eparentPath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003enode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003elabel\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ename\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!==\u003c/span\u003e \u003cspan class=\"token string\"\u003e'opol'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword control-flow\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003ch2 class=\"heading lv-2\"\u003e本当の完成\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eこれで完成！\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js pre\"\u003e\u003ccode class=\"language-js code\"\u003e\u003cspan class=\"token class-name\"\u003eArray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eprototype\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string\"\u003e'\u0026#x3C;\u0026#x3C;'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eitems\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eitems\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\nopol\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  a \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  a \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  a \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  puts \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// =\u003e [1,2,3]\u003c/span\u003e\n\n  \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token string\"\u003e'==='\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  puts \u003cspan class=\"token operator\"\u003e\u0026#x3C;\u0026#x3C;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ea \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// true\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eこれできれいな構文や気味の悪い構文を自由にかけるようになりました。\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003e課題\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003eESLintや型の解決が一切行われないので\n知らない人が見ると一体何が起きているのかわからない状態となります...:grimacing:\nもちろんですがTypeScriptでは使えません。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e\u003cdel\u003eあとテストも書けてません。（動作確認も怪しいです）\u003c/del\u003e テスト書きました\n課題まみれです。\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e最後に\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e長年の夢だったJavaScriptでの演算子オーバーロードを実現することができました。\n正直実用的ではないですが、普段の業務では扱わないような技術で頭の体操になりますね。\n本当はもっといろんなことをやりたかったのですが間に合わなかったので少しずつ機能を足していければと思います。(npmへもそのうち上げたいです）\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eそして、今回はbabel経由でASTの操作を行いました。\nASTを扱うのはハードルが高いように感じますがとても簡単なのでぜひ皆さんも触ってみてください。\u003c/p\u003e\n\u003chr\u003e\n\u003cp class=\"paragraph\"\u003eおしまい\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e参考サイト\u003c/h2\u003e\n\u003cul class=\"list unordered\"\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/jamiebuilds/babel-handbook/blob/master/translations/ja/plugin-handbook.md\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://github.com/jamiebuilds/babel-handbook/blob/master/translations/ja/plugin-handbook.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://efcl.info/2019/12/03/dive-to-ast/\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://efcl.info/2019/12/03/dive-to-ast/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://sakura.io/blog/2017/12/13/babel-plugins/\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003ehttps://sakura.io/blog/2017/12/13/babel-plugins/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"javascript_operator_overload_plugin"},"buildId":"2TeC_BqFkmcRD1K9YUrqZ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-51ce6eb9ed73aacaf515.js"></script><script src="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" async=""></script><script src="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" async=""></script><script src="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_buildManifest.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_ssgManifest.js" async=""></script></body></html>