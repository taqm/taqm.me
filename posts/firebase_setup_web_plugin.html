<!DOCTYPE html><html lang="ja"><head><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-X38HKLJWTQ"></script><script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-X38HKLJWTQ', { page_path: window.location.pathname, }); </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="robots" content="nofollow noindex"/><title>FirebaseのWebプロジェクトをビルドしやすくするモジュールを作った | taqm&#x27;s blog</title><meta name="keywords" content="Firebase,JavaScript"/><meta name="description" content="firebase setup:webを同期的にnode.jsから呼び出しやすくするためのライブラリを作ったので解説します。"/><meta property="og:url" content="https://taqm.me/posts/firebase_setup_web_plugin"/><meta property="og:type" content="article"/><meta property="og:title" content="FirebaseのWebプロジェクトをビルドしやすくするモジュールを作った | taqm&amp;apos;s blog"/><meta property="og:image" content="https://taqm.me/static/site_logo.png"/><meta property="og:description" content="firebase setup:webを同期的にnode.jsから呼び出しやすくするためのライブラリを作ったので解説します。"/><meta property="og:site_name" content="taqm.me"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="taqm"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/3bd3ee853585bdba2b55.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3bd3ee853585bdba2b55.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.286c5ad94e4334e87283.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" as="script"/><link rel="preload" href="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" as="script"/><link rel="preload" href="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" as="script"/><style id="__jsx-2615209551">.inner.jsx-2615209551{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:2.5rem;}@media (min-width:640px){.inner.jsx-2615209551{-webkit-box-pack:start;-webkit-justify-content:flex-start;-ms-flex-pack:start;justify-content:flex-start;height:4rem;padding-left:1.5rem;padding-right:1.5rem;}}</style></head><body><div id="__next"><header class="jsx-2615209551 border-b border-gray-200 bg-white"><div class="jsx-2615209551 inner max-w-screen-lg mx-auto"><a class="jsx-2615209551 text-xl sm:text-2xl" href="/">taqm&#x27;blog</a></div></header><main class="container py-16"><article class="post-page"><div class="text-sm text-gray-500">2019-03-13</div><h1 class="text-2xl font-bold">FirebaseのWebプロジェクトをビルドしやすくするモジュールを作った</h1><ul class="flex flex-wrap mt-2"><li class="mr-2 bg-gray-200 hover:bg-gray-300"><a class="block px-2 h-full text-sm" href="/tags/Firebase">Firebase</a></li><li class="mr-2 bg-gray-200 hover:bg-gray-300"><a class="block px-2 h-full text-sm" href="/tags/JavaScript">JavaScript</a></li></ul><div class="mt-10"><h2 class="heading lv-2">注意</h2>
<p class="paragraph">2020/11/12現在このライブラリは動作しないです。
そのうち更新しますがご注意ください</p>
<h2 class="heading lv-2">はじめに</h2>
<p class="paragraph">FirebaseでWebプロジェクトを作る際に
<code class="code">API_KEY</code>などをGitでどう管理するか悩んだ結果、
管理しなくて済むようにビルド時に解決するモジュールを作ったので紹介します。</p>
<h2 class="heading lv-2">成果物</h2>
<p class="paragraph">とりあえず成果物を見たい方はこちらをどうぞ</p>
<p class="paragraph"><a href="https://github.com/taqm/firebase-setup-web" class="anchor" rel="noopener noreferrer" target="_blank">GitHub</a>
<a href="https://www.npmjs.com/package/firebase-setup-web" class="anchor" rel="noopener noreferrer" target="_blank">npm</a></p>
<h2 class="heading lv-2">背景</h2>
<p class="paragraph">最近よく目にする<code class="code">Firebase</code>ですが、
Webプロジェクトでは初期化のため以下のような記述が必要です。</p>
<div class="remark-highlight"><pre class="language-javascript pre"><code class="language-javascript code"><span class="token keyword">const</span> firebase <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"firebase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  apiKey<span class="token operator">:</span> <span class="token string">"XXXXX"</span><span class="token punctuation">,</span>
  authDomain<span class="token operator">:</span> <span class="token string">"XXXXX.firebaseapp.com"</span><span class="token punctuation">,</span>
  databaseURL<span class="token operator">:</span> <span class="token string">"https://XXXXX.firebaseio.com"</span><span class="token punctuation">,</span>
  projectId<span class="token operator">:</span> <span class="token string">"XXXXX"</span><span class="token punctuation">,</span>
  storageBucket<span class="token operator">:</span> <span class="token string">"XXXXX.appspot.com"</span><span class="token punctuation">,</span>
  messagingSenderId<span class="token operator">:</span> <span class="token string">"XXXXX"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
firebase<span class="token punctuation">.</span><span class="token method function property-access">initializeApp</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph">（↑ 公式のサンプルを少しいじったもの</p>
<p class="paragraph">こういうチュートリアル的な記述って
キーとかが文字リテラルでべた書きされていることが多いのですが
「Gitでどう管理するんだ？」ってなりますよね :rolling_eyes:</p>
<h2 class="heading lv-2">管理方法</h2>
<h3 class="heading lv-3">ベタ書きのまま</h3>
<p class="paragraph">別に見られて困るものでもないのでそれでもいいと思います。
さらにプライベートリポジトリならまず問題ないでしょう。</p>
<p class="paragraph">でも定数がソースコードにベタ書きなのは、
精神衛生上は良くないのでこれは採用したくないです。</p>
<p class="paragraph">（あと開発が１環境で済むはずがないですし</p>
<h3 class="heading lv-3">ビルド時に環境変数から取得</h3>
<p class="paragraph">大体の場合は環境変数に突っ込むことが選択肢の上位になりますよね。</p>
<p class="paragraph"><code class="code">webpack.config.js</code>や<code class="code">nuxt.config.js</code>、<code class="code">gulpfile.js</code>など
ビルド設定スクリプトで環境変数を参照することで解決します。</p>
<p class="paragraph">そしてローカル環境で環境変数の設定は面倒なので
<code class="code">dotenv</code>や<code class="code">env-cmd</code>を使うことになると思います。</p>
<p class="paragraph">割といい感じかと思いましたが、
ボクは値そのものを管理したくないし見たくもないのです。</p>
<p class="paragraph"><strong>ちなみに</strong>
この<code class="code">.env</code>ファイルや↑のベタ書きファイルを
GitHubのパブリックリポジトリに突っ込むとGitHubさんから連絡がきます。</p>
<h3 class="heading lv-3">firebase-toolsを使って動的に取得</h3>
<p class="paragraph">firebaseのcliとしてインストールする <code class="code">firebase-tools</code>。
こちらを使うことで現在有効になっているfirebaseプロジェクトの設定が取得できます。</p>
<div class="remark-highlight"><pre class="language-javascript pre"><code class="language-javascript code"><span class="token keyword">const</span> firebaseTools <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'firebase-tools'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
firebaseTools<span class="token punctuation">.</span><span class="token property-access">setup</span><span class="token punctuation">.</span><span class="token method function property-access">web</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ここで設定から処理を行える</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph">かなりいい感じです！
ただし困った点が...</p>
<p class="paragraph">この機能は非同期な処理なので、
同期的な処理の中に組み込みづらいんですよね :frowning2:</p>
<h2 class="heading lv-2">作りました</h2>
<p class="paragraph">結局どれもしっくり来なかったので
↓この２つを要件として作りました</p>
<ul class="list unordered">
<li>同期的にJSONが取得できる</li>
<li>このために別モジュールを必要としない（なにかに依存しない）</li>
</ul>
<h3 class="heading lv-3">使い方</h3>
<p class="paragraph">このモジュールは対象のプロジェクトで
<code class="code">firebase setup:web</code>コマンドが実行できることが前提です！
firebaseの開発者はみんな実行できますよね...?</p>
<p class="paragraph">今回作成した<code class="code">firebase-setup-web</code>を読み込むことで
同期的に設定を読み込みJSONで扱えるようにしてくれます。
Webpackで利用する場合を例として紹介します。</p>
<p class="paragraph">■ <code class="code">Webpack.DefinePlugin</code>で使う場合</p>
<div class="has-filename"><div class="filename">webpack.config.js</div><pre class="language-javascript pre"><code class="language-javascript code"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'firebase-setup-web'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> defParams <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">'process.env.FB_PROJECT_ID'</span><span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token property-access">projectId</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// webpack config</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span>defParam<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph">↑のように設定情報を変換したい文字列として登録してあげます。</p>
<p class="paragraph">読み込むだけで設定オブジェクトが取得できるので、自由にビルドの設定を行いましょう。
もちろんただのスクリプトなので<code class="code">nuxt.config.js</code>などでも使えます:ok_hand:</p>
<h3 class="heading lv-3">CIの中で使う</h3>
<p class="paragraph">CIで利用する場合には
<code class="code">firebase login:ci</code>というコマンドで取得できるトークンを利用します。
ビルド時に環境変数<code class="code">FB_CI_TOKEN</code>へ上記コマンドの結果を設定してください。</p>
<p class="paragraph">環境変数が存在すればそのトークンからプロジェクト情報を取得します。</p>
<h3 class="heading lv-3">型定義</h3>
<p class="paragraph">ちゃんと<code class="code">index.d.ts</code>も用意したのでTypeScriptでも扱いやすいです！</p>
<h3 class="heading lv-3">実装の解説</h3>
<p class="paragraph"><code class="code">firebase</code>コマンドの中に<code class="code">setup:web</code>というサブコマンドがあり、
これを実行することで現在有効なプロジェクト設定を取得することができます。
（前述した<strong>firebase-toolsを使って動的に取得</strong>と内部的には同じ処理が動くようです。</p>
<p class="paragraph">早速実行!</p>
<div class="remark-highlight"><pre class="language-bash pre"><code class="language-bash code">$ firebase setup:web

// Copy and <span class="token function">paste</span> this into your JavaScript code to initialize the Firebase SDK.
// You will also need to load the Firebase SDK.
// See https://firebase.google.com/docs/web/setup <span class="token keyword">for</span> <span class="token function">more</span> details.

firebase.initializeApp<span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">"apiKey"</span><span class="token builtin class-name">:</span> <span class="token string">"XXXXX"</span>,
  <span class="token string">"authDomain"</span><span class="token builtin class-name">:</span> <span class="token string">"XXXXX.firebaseapp.com"</span>,
  <span class="token string">"databaseURL"</span><span class="token builtin class-name">:</span> <span class="token string">"https://XXXXX.firebaseio.com"</span>,
  <span class="token string">"projectId"</span><span class="token builtin class-name">:</span> <span class="token string">"XXXXX"</span>,
  <span class="token string">"storageBucket"</span><span class="token builtin class-name">:</span> <span class="token string">"XXXXX.appspot.com"</span>,
  <span class="token string">"messagingSenderId"</span><span class="token builtin class-name">:</span> <span class="token string">"XXXXX"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph">うぐっ！！！
なんと使いづらい....</p>
<p class="paragraph">すごく親切で「これをコピペしてね！」って言ってますが、
今回欲しいのは中のJSONだけなのです。</p>
<h4 class="heading lv-4">コマンドの結果をパース</h4>
<p class="paragraph">最終的なビルドはJavaScriptで書くので、パース処理もJavaScriptで記述します。
コマンドは<code class="code">child_process</code>を使って実行！</p>
<div class="has-filename"><div class="filename">index.js</div><pre class="language-javascript pre"><code class="language-javascript code"><span class="token keyword">const</span> <span class="token punctuation">{</span> execSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> firebase <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">initializeApp</span><span class="token operator">:</span> <span class="token parameter">c</span> <span class="token arrow operator">=></span> c<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">CMD</span> <span class="token operator">=</span> <span class="token string">'firebase setup:web'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token constant">CMD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fnc <span class="token operator">=</span> <span class="token maybe-class-name">Buffer</span><span class="token punctuation">.</span><span class="token keyword module">from</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span>fnc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eslint-disable-line no-eval</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
</code></pre></div>
<p class="paragraph">せっかくGoogleさんが親切に実行できる形で出力してくれているので、
<code class="code">firebase.initializeApp</code>を実際に用意して実行してあげましょう。</p>
<p class="paragraph"><code class="code">initializeApp</code>には設定オブジェクトが渡ってくるのでそのまま返却します。
そしてエクスポート。</p>
<p class="paragraph">これでこのモジュールを読み込むとfirebaseの設定が取得できます :relaxed:</p>
<h2 class="heading lv-2">課題</h2>
<p class="paragraph">１つのアプリで複数のFirebaseプロジェクトを扱う場合には
このモジュールを使うことはできません。
どれくらい需要がある機能なのかも不明なためとりあえずそのままで。</p>
<h2 class="heading lv-2">まとめ</h2>
<p class="paragraph">実装は１ファイルで依存もなし。これだけ聞くとかなり優秀なモジュールが完成しました。</p>
<p class="paragraph">ただコマンド叩いていたり、evalを使ったりとあまりよくない実装ですが
ビルド用のスクリプトなので目をつむっていただけると...（汗</p>
<p class="paragraph">あまり類似ツールが存在するかは調べていないので
他に良いツールがあったりする場合は教えていただけると嬉しいです！</p>
<hr>
<p class="paragraph">おしまい</p></div></article></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":"{\"slug\":\"firebase_setup_web_plugin\",\"title\":\"FirebaseのWebプロジェクトをビルドしやすくするモジュールを作った\",\"publishedAt\":\"2019-03-13T22:34:57.000Z\",\"description\":\"firebase setup:webを同期的にnode.jsから呼び出しやすくするためのライブラリを作ったので解説します。\",\"tags\":[\"Firebase\",\"JavaScript\"]}","content":"\u003ch2 class=\"heading lv-2\"\u003e注意\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e2020/11/12現在このライブラリは動作しないです。\nそのうち更新しますがご注意ください\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003eはじめに\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eFirebaseでWebプロジェクトを作る際に\n\u003ccode class=\"code\"\u003eAPI_KEY\u003c/code\u003eなどをGitでどう管理するか悩んだ結果、\n管理しなくて済むようにビルド時に解決するモジュールを作ったので紹介します。\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e成果物\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003eとりあえず成果物を見たい方はこちらをどうぞ\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e\u003ca href=\"https://github.com/taqm/firebase-setup-web\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003eGitHub\u003c/a\u003e\n\u003ca href=\"https://www.npmjs.com/package/firebase-setup-web\" class=\"anchor\" rel=\"noopener noreferrer\" target=\"_blank\"\u003enpm\u003c/a\u003e\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e背景\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e最近よく目にする\u003ccode class=\"code\"\u003eFirebase\u003c/code\u003eですが、\nWebプロジェクトでは初期化のため以下のような記述が必要です。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-javascript pre\"\u003e\u003ccode class=\"language-javascript code\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e firebase \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\"firebase\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e config \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  apiKey\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  authDomain\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX.firebaseapp.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  databaseURL\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"https://XXXXX.firebaseio.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  projectId\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  storageBucket\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX.appspot.com\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  messagingSenderId\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nfirebase\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003einitializeApp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econfig\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003e（↑ 公式のサンプルを少しいじったもの\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eこういうチュートリアル的な記述って\nキーとかが文字リテラルでべた書きされていることが多いのですが\n「Gitでどう管理するんだ？」ってなりますよね :rolling_eyes:\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e管理方法\u003c/h2\u003e\n\u003ch3 class=\"heading lv-3\"\u003eベタ書きのまま\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003e別に見られて困るものでもないのでそれでもいいと思います。\nさらにプライベートリポジトリならまず問題ないでしょう。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eでも定数がソースコードにベタ書きなのは、\n精神衛生上は良くないのでこれは採用したくないです。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e（あと開発が１環境で済むはずがないですし\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003eビルド時に環境変数から取得\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003e大体の場合は環境変数に突っ込むことが選択肢の上位になりますよね。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e\u003ccode class=\"code\"\u003ewebpack.config.js\u003c/code\u003eや\u003ccode class=\"code\"\u003enuxt.config.js\u003c/code\u003e、\u003ccode class=\"code\"\u003egulpfile.js\u003c/code\u003eなど\nビルド設定スクリプトで環境変数を参照することで解決します。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eそしてローカル環境で環境変数の設定は面倒なので\n\u003ccode class=\"code\"\u003edotenv\u003c/code\u003eや\u003ccode class=\"code\"\u003eenv-cmd\u003c/code\u003eを使うことになると思います。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e割といい感じかと思いましたが、\nボクは値そのものを管理したくないし見たくもないのです。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e\u003cstrong\u003eちなみに\u003c/strong\u003e\nこの\u003ccode class=\"code\"\u003e.env\u003c/code\u003eファイルや↑のベタ書きファイルを\nGitHubのパブリックリポジトリに突っ込むとGitHubさんから連絡がきます。\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003efirebase-toolsを使って動的に取得\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003efirebaseのcliとしてインストールする \u003ccode class=\"code\"\u003efirebase-tools\u003c/code\u003e。\nこちらを使うことで現在有効になっているfirebaseプロジェクトの設定が取得できます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-javascript pre\"\u003e\u003ccode class=\"language-javascript code\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e firebaseTools \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'firebase-tools'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nfirebaseTools\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003esetup\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eweb\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003econfig\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// ここで設定から処理を行える\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eかなりいい感じです！\nただし困った点が...\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eこの機能は非同期な処理なので、\n同期的な処理の中に組み込みづらいんですよね :frowning2:\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e作りました\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e結局どれもしっくり来なかったので\n↓この２つを要件として作りました\u003c/p\u003e\n\u003cul class=\"list unordered\"\u003e\n\u003cli\u003e同期的にJSONが取得できる\u003c/li\u003e\n\u003cli\u003eこのために別モジュールを必要としない（なにかに依存しない）\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 class=\"heading lv-3\"\u003e使い方\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003eこのモジュールは対象のプロジェクトで\n\u003ccode class=\"code\"\u003efirebase setup:web\u003c/code\u003eコマンドが実行できることが前提です！\nfirebaseの開発者はみんな実行できますよね...?\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e今回作成した\u003ccode class=\"code\"\u003efirebase-setup-web\u003c/code\u003eを読み込むことで\n同期的に設定を読み込みJSONで扱えるようにしてくれます。\nWebpackで利用する場合を例として紹介します。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e■ \u003ccode class=\"code\"\u003eWebpack.DefinePlugin\u003c/code\u003eで使う場合\u003c/p\u003e\n\u003cdiv class=\"has-filename\"\u003e\u003cdiv class=\"filename\"\u003ewebpack.config.js\u003c/div\u003e\u003cpre class=\"language-javascript pre\"\u003e\u003ccode class=\"language-javascript code\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e config \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'firebase-setup-web'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e defParams \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token string\"\u003e'process.env.FB_PROJECT_ID'\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token known-class-name class-name\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003estringify\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003econfig\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eprojectId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// webpack config\u003c/span\u003e\nmodule\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexports\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  plugins\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ewebpack\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eDefinePlugin\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edefParam\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003e↑のように設定情報を変換したい文字列として登録してあげます。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e読み込むだけで設定オブジェクトが取得できるので、自由にビルドの設定を行いましょう。\nもちろんただのスクリプトなので\u003ccode class=\"code\"\u003enuxt.config.js\u003c/code\u003eなどでも使えます:ok_hand:\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003eCIの中で使う\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003eCIで利用する場合には\n\u003ccode class=\"code\"\u003efirebase login:ci\u003c/code\u003eというコマンドで取得できるトークンを利用します。\nビルド時に環境変数\u003ccode class=\"code\"\u003eFB_CI_TOKEN\u003c/code\u003eへ上記コマンドの結果を設定してください。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e環境変数が存在すればそのトークンからプロジェクト情報を取得します。\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003e型定義\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003eちゃんと\u003ccode class=\"code\"\u003eindex.d.ts\u003c/code\u003eも用意したのでTypeScriptでも扱いやすいです！\u003c/p\u003e\n\u003ch3 class=\"heading lv-3\"\u003e実装の解説\u003c/h3\u003e\n\u003cp class=\"paragraph\"\u003e\u003ccode class=\"code\"\u003efirebase\u003c/code\u003eコマンドの中に\u003ccode class=\"code\"\u003esetup:web\u003c/code\u003eというサブコマンドがあり、\nこれを実行することで現在有効なプロジェクト設定を取得することができます。\n（前述した\u003cstrong\u003efirebase-toolsを使って動的に取得\u003c/strong\u003eと内部的には同じ処理が動くようです。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e早速実行!\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash pre\"\u003e\u003ccode class=\"language-bash code\"\u003e$ firebase setup:web\n\n// Copy and \u003cspan class=\"token function\"\u003epaste\u003c/span\u003e this into your JavaScript code to initialize the Firebase SDK.\n// You will also need to load the Firebase SDK.\n// See https://firebase.google.com/docs/web/setup \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token function\"\u003emore\u003c/span\u003e details.\n\nfirebase.initializeApp\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token string\"\u003e\"apiKey\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX\"\u003c/span\u003e,\n  \u003cspan class=\"token string\"\u003e\"authDomain\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX.firebaseapp.com\"\u003c/span\u003e,\n  \u003cspan class=\"token string\"\u003e\"databaseURL\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"https://XXXXX.firebaseio.com\"\u003c/span\u003e,\n  \u003cspan class=\"token string\"\u003e\"projectId\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX\"\u003c/span\u003e,\n  \u003cspan class=\"token string\"\u003e\"storageBucket\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX.appspot.com\"\u003c/span\u003e,\n  \u003cspan class=\"token string\"\u003e\"messagingSenderId\"\u003c/span\u003e\u003cspan class=\"token builtin class-name\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"XXXXX\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eうぐっ！！！\nなんと使いづらい....\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eすごく親切で「これをコピペしてね！」って言ってますが、\n今回欲しいのは中のJSONだけなのです。\u003c/p\u003e\n\u003ch4 class=\"heading lv-4\"\u003eコマンドの結果をパース\u003c/h4\u003e\n\u003cp class=\"paragraph\"\u003e最終的なビルドはJavaScriptで書くので、パース処理もJavaScriptで記述します。\nコマンドは\u003ccode class=\"code\"\u003echild_process\u003c/code\u003eを使って実行！\u003c/p\u003e\n\u003cdiv class=\"has-filename\"\u003e\u003cdiv class=\"filename\"\u003eindex.js\u003c/div\u003e\u003cpre class=\"language-javascript pre\"\u003e\u003ccode class=\"language-javascript code\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e execSync \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003erequire\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'child_process'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e firebase \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function-variable function\"\u003einitializeApp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token parameter\"\u003ec\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e c\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token constant\"\u003eCMD\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e'firebase setup:web'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e res \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eexecSync\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token constant\"\u003eCMD\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e fnc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eBuffer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token keyword module\"\u003efrom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eres\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e'utf-8'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003etoString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e config \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eeval\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003efnc\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// eslint-disable-line no-eval\u003c/span\u003e\nmodule\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003eexports\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e config\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp class=\"paragraph\"\u003eせっかくGoogleさんが親切に実行できる形で出力してくれているので、\n\u003ccode class=\"code\"\u003efirebase.initializeApp\u003c/code\u003eを実際に用意して実行してあげましょう。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003e\u003ccode class=\"code\"\u003einitializeApp\u003c/code\u003eには設定オブジェクトが渡ってくるのでそのまま返却します。\nそしてエクスポート。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eこれでこのモジュールを読み込むとfirebaseの設定が取得できます :relaxed:\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003e課題\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e１つのアプリで複数のFirebaseプロジェクトを扱う場合には\nこのモジュールを使うことはできません。\nどれくらい需要がある機能なのかも不明なためとりあえずそのままで。\u003c/p\u003e\n\u003ch2 class=\"heading lv-2\"\u003eまとめ\u003c/h2\u003e\n\u003cp class=\"paragraph\"\u003e実装は１ファイルで依存もなし。これだけ聞くとかなり優秀なモジュールが完成しました。\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eただコマンド叩いていたり、evalを使ったりとあまりよくない実装ですが\nビルド用のスクリプトなので目をつむっていただけると...（汗\u003c/p\u003e\n\u003cp class=\"paragraph\"\u003eあまり類似ツールが存在するかは調べていないので\n他に良いツールがあったりする場合は教えていただけると嬉しいです！\u003c/p\u003e\n\u003chr\u003e\n\u003cp class=\"paragraph\"\u003eおしまい\u003c/p\u003e"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"firebase_setup_web_plugin"},"buildId":"2TeC_BqFkmcRD1K9YUrqZ","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-51ce6eb9ed73aacaf515.js"></script><script src="/_next/static/chunks/main-8741ed3c7ec57f378f59.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.daa7383ad2ab2e6757c1.js" async=""></script><script src="/_next/static/chunks/commons.286c5ad94e4334e87283.js" async=""></script><script src="/_next/static/chunks/pages/_app-62c4ae74494db6a57e9e.js" async=""></script><script src="/_next/static/chunks/79afb1f29f0e22fb2195c114356294f95861ebcc.293ad4049eec03f4e065.js" async=""></script><script src="/_next/static/chunks/2c3b9bffc7150b37a7b3810dfcf1c0b0fac2bd18.26412b03d1df03d45396.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-d84c8237cab24ecd19e3.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_buildManifest.js" async=""></script><script src="/_next/static/2TeC_BqFkmcRD1K9YUrqZ/_ssgManifest.js" async=""></script></body></html>